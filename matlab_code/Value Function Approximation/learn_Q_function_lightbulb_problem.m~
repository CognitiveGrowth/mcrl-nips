%evaluate and tune Bayesian-SARSAQ with the features identified by linear
%regression
addpath('../MatlabTools/') %change to your directory for MatlabTools
addpath('../metaMDP/')
addpath('../Supervised/')


load ../../results/lightbulb_fit.mat

nr_actions=2;
nr_states=2;
gamma=1;

feature_names={'VPI','VOC1','VOC2','E[R|guess,b]','1'};
selected_features=[1;2;4];

nr_features=numel(selected_features); 


mdp=metaMDP(nr_actions,gamma,nr_features);

nr_episodes=10000;

fexr=@(s,a,mdp) feature_extractor(s,a,mdp,selected_features);


mdp.action_features=1:nr_features;

sigma0=1;
glm=BayesianGLM(nr_features,sigma0);
glm.mu_0=[1;1;1];
glm.mu_n=[1;1;1];
[glm,avg_MSE,R_total]=BayesianSARSAQ(mdp,fexr,nr_episodes,glm);

figure(),
subplot(2,1,1)
plot(smooth(avg_MSE,100))
xlabel('Episode','FontSize',16)
ylabel('Average MSE','FontSize',16)

subplot(2,1,2)
plot(smooth(R_total,100))
xlabel('Episode','FontSize',16)
ylabel('R_{total}','FontSize',16)


w=glm.mu_n;
figure()
bar(w)
ylabel('Learned Weights','FontSize',16)
set(gca,'XTickLabel',feature_names(selected_features),'FontSize',16)

%plot the corresponding fit to the Q-function
nr_states=size(lightbulb_problem.mdp.states,1);

for s=1:nr_states
    F(s,:)=fexr(lightbulb_problem.mdp.states(s,:),1,mdp);
end

valid_states=and(sum(lightbulb_problem.mdp.states,2)<=30,...
    sum(lightbulb_problem.mdp.states,2)>0);

Q_hat(:,1)=F*w;

figure()
scatter(Q_hat(valid_states),lightbulb_problem.fit.Q_star(valid_states,1))
set(gca,'FontSize',16)
xlabel(modelEquation(feature_names,w),'FontSize',16)
ylabel('$Q^\star$','FontSize',16,'Interpreter','LaTeX')
title(['Linear Fit to Q-function of 1-lightbulb meta-MDP, R^2=',num2str(R2)],'FontSize',16)
saveas(fig_Q,'../../results/figures/QFitToyProblem.fig')
saveas(fig_Q,'../../results/figures/QFitToyProblem.png')
